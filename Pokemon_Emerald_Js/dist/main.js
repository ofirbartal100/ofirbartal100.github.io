!function(t){var e={};function s(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)s.d(i,o,function(e){return t[e]}.bind(null,o));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(){this.grid=[]}forEach(t){this.grid.forEach((e,s)=>{e.forEach((e,i)=>{t(e,s,i)})})}get(t,e){const s=this.grid[t];if(s)return s[e]}set(t,e,s){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=s}}class o{constructor(t,e){this.set(t,e),this.tileSize=16}set(t,e){this.x=t,this.y=e}distance(t){let e=this.x*this.x*t*t,s=this.y*this.y*t*t;return Math.sqrt(e+s)}distanceX(t){return this.x*t}distanceY(t){return this.y*t}toIndex(){return[Math.floor(this.x/this.tileSize),Math.floor(this.y/this.tileSize)]}}class a{constructor(){this.pos=new o(0,0),this.size=new o(240,160)}}class n{constructor(t=1/60){let e=0,s=0;this.updateProxy=i=>{for(e+=(i-s)/1e3;e>t;)this.update(t),e-=t;s=i,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class h{constructor(){this.keyStates=new Map,this.keyMap=new Map}addMapping(t,e){this.keyMap.set(t,e)}handleEvent(t){const{code:e}=t;if(!this.keyMap.has(e))return!1;t.preventDefault();const s="keydown"===t.type?1:0;this.keyStates.get(e)!==s&&(this.keyStates.set(e,s),this.keyMap.get(e)(s))}listenTo(t){["keydown","keyup"].forEach(e=>{t.addEventListener(e,t=>{this.handleEvent(t)})})}}const r=["ArrowRight","ArrowLeft","ArrowUp","ArrowDown"],l=["KeyZ","KeyX","ShiftRight"];class c{constructor(){}move(t,e){e&&("ArrowUp"==t?this.up():"ArrowDown"==t?this.down():"ArrowRight"==t?this.right():"ArrowLeft"==t&&this.left())}action(t,e){e&&(t==l[0]?this.a():t==l[1]?this.b():t==l[2]&&this.start())}up(){}down(){}left(){}right(){}a(){}b(){}start(){}}class d extends c{constructor(t){super(),this.menuRef=t,this.menuCursor=0}up(){let t=this.menuRef.items.length;this.menuCursor=(this.menuCursor+(t-1))%t}down(){let t=this.menuRef.items.length;this.menuCursor=(this.menuCursor+1)%t}left(){}right(){}a(){this.choose(this.menuCursor)}b(){this.active=!1}start(){}choose(t){this.chosenItem=this.menuRef.items[t],this.menuRef.routAction("init",!0)}}class u{constructor(){this.controller=new d(this),this.items=["Bag","Pokemons","Brendan","Save","Settings"],this.focus=0,this.active=!1,this.chosenItem=!1,this.player,this.font}move(t,e){this.controller.move(t,e)}action(t,e){this.controller.action(t,e)}update(t){this.active&&(this.layer=function(t){const e=document.createElement("canvas");e.width=60,e.height=150;const s=e.getContext("2d");return function(i){s.clearRect(0,0,e.width,e.height),s.fillStyle="#FFF",s.fillRect(0,5,e.width-5,e.height),i.drawImage(e,240-e.width,0);let o=0;for(let a of t.items)s.clearRect(0,0,e.width,e.height),t.font.putText(a,0,5+e.height*o/5,s),o==t.controller.menuCursor&&(s.strokeStyle="red",s.strokeRect(0,5+e.height*o/5,e.width-5,13)),i.drawImage(e,240-e.width,0),o++}}(this))}draw(t){this.active&&this.layer(t)}}function g(t){const e=document.createElement("canvas");e.width=230,e.height=40;const s=e.getContext("2d");return s.font="7px Arial",function(i){s.clearRect(0,0,e.width,e.height),s.fillStyle="#FFF",s.fillRect(0,0,e.width,e.height),i.drawImage(e,5,160-e.height-5),s.clearRect(0,0,e.width,e.height),s.fillStyle="#000",s.fillText(t,0,7),i.drawImage(e,5,160-e.height-5)}}class p{constructor(){this.messages=[],this.options=["Yes","No"],this.messagePhase=-1,this.focus=0,this.active=!1}initMessages(t=0){this.active=!0,this.messagePhase=t}addMessages(t){for(let e of t)this.messages.push(e)}clearMessages(){this.messagePhase=0,this.messages=[]}nextMessage(){this.messagePhase=this.messagePhase+1,null==this.messages[this.messagePhase]&&this.endOfMessageHandler()}endOfMessageHandler(){this.clearMessages(),this.active=!1}move(t,e){"ArrowUp"==t?e&&(this.focus=(this.focus-1+this.options.length)%this.options.length):"ArrowDown"==t&&e&&(this.focus=(this.focus+1+this.options.length)%this.options.length)}action(t,e){t==l[0]||t==l[1]?e&&this.nextMessage():t==l[2]&&e&&this.nextMessage()}update(t){this.active&&(this.layer=g(this.messages[this.messagePhase]))}updateComponent(t){}drawComponent(t){g(this.messages[this.messagePhase])(t)}draw(t){this.active&&this.layer(t)}}function m(t,e,s,i,o){const a=document.createElement("canvas");a.width=120,a.height=40;const n=e%2,h=e/2-13*n/a.height,r=a.getContext("2d");r.font="Ariel 7px black";const l=i[18],c=i[17],d=i[15],u=i[16],g=i[10],p=i[9],m=i[14];return function(e){if(r.clearRect(0,0,a.width,a.height),s){let e;o&&s.currHP>0?e=l:o&&0==s.currHP?e=c:!o&&s.currHP>0?e=d:o||0!=s.currHP||(e=u),r.drawImage(e,0,0,a.width,a.height);let i=0;s.iconAnimateTime+=t,s.iconAnimateTime>.25&&s.iconAnimateTime<.5?i=64:s.iconAnimateTime>=.5&&(s.iconAnimateTime=0),0==s.currHP&&(s.iconAnimateTime=0),r.drawImage(s.icon,i,0,64,64,0,0,32,32),r.fillText(s.name,35,14),r.drawImage(g,32,20,80,7);let n=s.currHP/s.HP,h=0;n<.5&&n>=.2?h=1:n<.2&&(h=2),r.drawImage(p,0,8*h,55*n,8,49,21,60*n,4)}else r.drawImage(m,0,0,a.width,a.height);e.drawImage(a,n*a.width,h*a.height)}}function f(t,e,s,i,o,a={font:"7px Arial",fill:"#FFF",border:"#000"}){const n=document.createElement("canvas");n.width=s,n.height=i;const h=n.getContext("2d");return h.font=a.font,function(r){h.clearRect(0,0,n.width,n.height),h.fillStyle=a.fill,h.fillRect(0,0,s,i),h.strokeStyle=a.border,h.strokeRect(0,0,s,i),o&&(h.fillStyle="#000",h.fillText(o,5,i/2-3.5)),r.drawImage(n,t,e)}}function y(t,e){const s=document.createElement("canvas");s.width=240,s.height=160;let i=e.graphics;const o=s.getContext("2d"),a=i[0];return function(i){o.drawImage(a,0,0,240,160),function(t,e,s){let i=t.controller.getSelectedIndex().pokemon;for(let o=0;o<6;o++)m(e,o,t.party.pokemons[o],t.graphics,i==o)(s)}(e,t,o),function(t,e){let s=t.graphics;const i=s[3],o=s[6];0==t.controller.stage||2==t.controller.stage?(t.controller.partyCursor.y==Math.min(4,t.party.pokemons.length/2+1)-1?e.drawImage(o,205,145,35,15):e.drawImage(i,205,145,35,15),e.fillStyle="#FFF",e.fillText("Cancel",206,155),f(0,135,200,25,t.dialogPhrase)(e)):1==t.controller.stage&&(!function(t,e,s,i,o,a,n){const h={font:"7px Arial",fill:"#FFF",border:"#F00"};let r,l=[];if(t[0].Name)for(let e of t)l.push(e.Name);else for(let e of t)l.push(e);for(let t=0;t<l.length;t++)r=l.length-1-t==e?h:void 0,f(s,i-(t+1)*a,o,a,l[l.length-1-t],r)(n)}(t.pokemonMenu,t.controller.getSelectedIndex().menu,190,160,50,20,e),f(0,135,180,25,t.dialogPhrase)(e))}(e,o),3==e.controller.stage&&function(t,e){let s=2*t.controller.partyCursor.y+t.controller.partyCursor.x,i=t.controller.summeryCursor;!function(t,e){const s=document.createElement("canvas");s.width=240,s.height=160;const i=s.getContext("2d"),o=[e[29],e[30],e[31],e[32],e[33]];return function(e,a){i.clearRect(0,0,s.width,s.height),i.drawImage(o[a],0,0,s.width,s.height),i.drawImage(t.front,15,60,64,64),i.fillText(t.name,15,35),i.fillText(t.level,22,48),e.drawImage(s,0,0)}}(t.party.pokemons[s],t.graphics)(e,i)}(e,o),i.drawImage(s,0,0)}}class w extends c{constructor(t){super(),this.partyPageRef=t,this.partyCursor=new o(0,0),this.partyMenuCursor=0,this.summeryCursor=0,this.switchPair=[],this.stage=0}up(){const t=Math.min(3,this.partyPageRef.party.pokemons.length/2)+1,e=this.partyPageRef.party.pokemons.length;if(0==this.stage||2==this.stage)this.partyCursor.y=(this.partyCursor.y+t-1)%t;else if(1==this.stage)this.partyMenuCursor=(this.partyMenuCursor+e-1)%e;else if(3==this.stage){let t=2*this.partyCursor.y+this.partyCursor.x;t=(t+(e-1))%e,this.partyCursor.y=Math.floor(t/2),this.partyCursor.x=t%2}}down(){const t=Math.min(3,this.partyPageRef.party.pokemons.length/2)+1,e=this.partyPageRef.party.pokemons.length;if(0==this.stage||2==this.stage)this.partyCursor.y=(this.partyCursor.y+1)%t;else if(1==this.stage)this.partyMenuCursor=(this.partyMenuCursor+1)%e;else if(3==this.stage){let t=2*this.partyCursor.y+this.partyCursor.x;t=(t+1)%e,this.partyCursor.y=Math.floor(t/2),this.partyCursor.x=t%2}}left(){0==this.stage||1==this.stage||2==this.stage?this.partyCursor.x=(this.partyCursor.x+1)%2:3==this.stage&&(this.summeryCursor=(this.summeryCursor+4)%5)}right(){0==this.stage||1==this.stage||2==this.stage?this.partyCursor.x=(this.partyCursor.x+1)%2:3==this.stage&&(this.summeryCursor=(this.summeryCursor+1)%5)}a(){switch(this.stage){case 0:this.partyCursor.y==Math.min(4,this.partyPageRef.party.pokemons.length/2+1)-1?this.b():this.openMenu();break;case 1:switch(this.partyPageRef.pokemonMenu[this.partyMenuCursor]){case"SUMMERY":this.showSummery();break;case"SWITCH":this.startSwitchPokemonPosition();break;case"SWITCH IN":this.partyPageRef.party.fightingPokemon=this.partyCursor.x+2*this.partyCursor.y,this.exit();break;case"ITEM":alert("and Item");break;case"CANCEL":this.closeMenu()}break;case 2:this.partyCursor.y==Math.min(4,this.partyPageRef.party.pokemons.length/2+1)-1?this.b():this.switchPokemonPosition()}}b(){switch(this.stage){case 0:this.partyCursor.set(0,0),this.partyPageRef.active=!1;break;case 1:case 2:case 3:this.closeMenu()}}start(){}openMenu(){this.stage=1,this.partyMenuCursor=0,this.partyPageRef.chosenPokemon=this.partyPageRef.party.pokemons[this.getSelectedIndex().pokemon],this.partyPageRef.dialogPhrase=`What To Do With ${this.partyPageRef.chosenPokemon.name} ?`}exit(){this.partyPageRef.active=!1,this.partyCursor.set(0,0),this.stage=0}closeMenu(){this.stage=0,this.partyPageRef.dialogPhrase="Choose a Pokemon."}getSelectedIndex(){return{pokemon:this.partyCursor.x+2*this.partyCursor.y,menu:this.partyMenuCursor}}startSwitchPokemonPosition(){this.stage=2,this.partyPageRef.dialogPhrase="Choose a Pokemon to switch with.",this.switchPair[0]=2*this.partyCursor.y+this.partyCursor.x}switchPokemonPosition(){this.switchPair[1]=2*this.partyCursor.y+this.partyCursor.x,this.partyPageRef.party.switch(...this.switchPair),this.closeMenu()}showSummery(){this.stage=3}}class v{constructor(){this.active=!1,this.graphics}}class b extends v{constructor(){super(),this.controller=new w(this),this.mode=1,this.party,this.pokemonMenu=["SUMMERY","SWITCH","ITEM","CANCEL"],this.chosenPokemon,this.dialogPhrase="Choose a Pokemon.",window.pp=this}battleMod(){this.mode=0,this.pokemonMenu=["SWITCH IN","SUMMERY","CANCEL"]}infoMod(){this.mode=1,this.pokemonMenu=["SUMMERY","SWITCH","ITEM","CANCEL"]}move(t,e){this.controller.move(t,e)}action(t,e){this.controller.action(t,e)}update(t){this.active&&(this.layer=y(t,this))}draw(t){this.active&&this.layer(t)}}class P extends v{constructor(){super(),this.menuType=1,this.bag,window.bb=this}move(t,e){}action(t,e){e&&(t==Commands[0]||t==Commands[1]||Commands[2])}update(t){this.active}draw(t){this.active}}class x extends v{constructor(){super()}}function k(t,e,s,i){const o=s[51],a=s[52],n=s[73],h=s[75],r=s[71];let l,c,d,u,g,p,m,f,y,w,v,b,P,x;i.font="8px Arial";let k,M,T,I,C,S,A=4;if(1==e){const e=t.player.party.getFightingPokemon();k=e.name,M=e.level,T=e.gender,I=120,C=70,p=e.HP,m=e.currHP,l=e.currHP/e.HP,c=136/260,d=40/85,u=96/260,g=6/85,f=e.levelEXP/e.levelUpEXP,y=40/260,w=76/85,v=192/260,b=4/85,A=20,S=o}else if(0==e){const e=t.foe.pokemon;l=e.currHP/e.HP,k=e.name,M=e.level,T=e.gender,I=0,C=8,c=118/260,d=40/62,u=96/260,g=6/62,S=a}P=I+(c+u/2)*S.width*.5,x=C+d*S.height*.5-h.height,i.drawImage(S,I,C,.5*S.width,.5*S.height);let E=0;l<.5&&l>=.2?E=1:l<.2&&(E=2),i.drawImage(n,0,E*n.height/3,n.width,n.height/3,I+c*S.width*.5,C+d*S.height*.5,u*S.width*l*.5,g*S.height*.5),1==e&&(i.fillStyle="#000",i.fillText(Math.floor(m)+"/"+p,I+134/260*S.width*.5,C+55/85*S.height*.5+6),i.drawImage(r,I+y*S.width*.5,C+w*S.height*.5,v*S.width*f*.5,b*S.height*.5)),t.dialog.font.putText(k,I+A,C+5,i),i.fillStyle="#000",i.drawImage(h,P,x,.5*h.width,.5*h.height),i.fillText(M,P+.5*h.width,x+8),"Male"==T?(i.fillStyle="#00F",i.fillRect(I+10,C+30,3,3)):"Female"==T&&(i.fillStyle="#F00",i.fillRect(I+10,C+30,3,3))}class M{constructor(){this.active=!1,this.PartyPage=null,this.BagPage=null,this.battle=null,this.battleData}move(t,e){this.PartyPage.active?this.PartyPage.move(t,e):this.BagPage.active||this.battle.move(t,e)}action(t,e){this.PartyPage.active?this.PartyPage.action(t,e):this.BagPage.active||this.battle.action(t,e)}init(t){t.init(this),this.battle=t,this.PartyPage.battleMod(),this.active=!0}end(){this.active=!1,this.battle.end(),this.battle=null,this.PartyPage.infoMod(),this.PartyPage.party.fightingPokemon=0}activateParty(){this.PartyPage.active=!0}activateBag(){}update(t){this.active&&(this.PartyPage.active?(this.PartyPage.update(t),this.layer=this.PartyPage.layer):this.BagPage.active||(this.battle.update(t),this.layer=function(t,e){const s=document.createElement("canvas");s.width=240,s.height=160;const i=s.getContext("2d");return i.font="10px Arial",function(o){t.foe.pokemon&&(i.clearRect(0,0,s.width,s.height),i.fillRect(0,0,s.width,s.height),t.arena&&i.drawImage(t.arena,0,0),i.drawImage(t.foe.pokemon.front,146,15,64,64),i.drawImage(t.player.party.pokemons[t.player.party.fightingPokemon].back,30,48,64,64),k(t,0,e,i),k(t,1,e,i),-1==t.dialog.stage&&t.dialog.loadBattle(t),t.dialog.drawComponent(i),o.drawImage(s,0,0))}}(this.battle,this.graphics)))}draw(t){this.active&&(this.PartyPage.active?this.PartyPage.layer(t):this.BagPage.active||this.layer(t))}}class T{constructor(t,e){if(t){for(let e in t)this[e]=t[e];this.typeTable=e}else this.name="Empty"}use(t,e){console.log(t,e);let s,i,o,a,n,h,r,l,c,d,u,g=[],p=0;a=1,n=1,d=1,u=1,l=1,h=this.generateCritical(t,e),r=this.generateRandom(),t.type1!=this.Type&&t.type2!=this.Type||(l=1.5,"ADAPTABILITY"==t.ability&&(l=2)),c=this.getTypeModifior(e.type1,e.type2),p=1*h*r*l*c*1*1;let m=parseInt(this.BasePower);return"Physical"==this.DamageCategory?(i=t.Attack,o=e.Defense):"Special"==this.DamageCategory&&(i=t.SpAttack,o=e.SpDefense),s=((2*t.level/5+2)*m*i/o/50+2)*p,e.hurt(s),g.push(`${t.name} used ${this.Name}`),h>1&&g.push("Its a Critical Hit!!"),2==c?g.push("it's super effective!!"):4==c?g.push("it's mega effective!!"):.5==c?g.push("it's not very effective.."):.25==c?g.push(`but it's almost nothing for ${e.pokemon.name}..`):0==c&&g.push(`it dosent work on ${e.name}..`),0==e.currHP&&g.push(e.name+" fainted.."),g}generateCritical(t,e){let s;return s=[1/16,1/8,.5][0],Math.random()<s?2:1}generateRandom(){return Math.random()*(1-.85)+.85}getTypeModifior(t,e){let s=1,i=this.typeTable.get(t);if(i.Immunities&&this.Type==i.Immunities)return 0;if(i.Weaknesses)for(let t of i.Weaknesses)this.Type==t&&(s*=2);if(i.Resistances)for(let t of i.Resistances)this.Type==t&&(s*=.5);if(e){let t=this.typeTable.get(e);if(t.Immunities&&this.Type==t.Immunities)return 0;if(t.Weaknesses)for(let e of t.Weaknesses)this.Type==e&&(s*=2);if(t.Resistances)for(let e of t.Resistances)this.Type==e&&(s*=.5)}return s}}class I{constructor(t){this.id=t,this.status=null,this.currHP=0,this.boosts=[0,0,0,0,0,0,0],this.moves=[],this.attacks=[],this.levelEXP=0,this.levelUpEXP=1e3,this.totalEXP=0,this.iconAnimateTime=0}gainEXP(t){for(this.levelEXP+=t,this.totalEXP+=t;this.levelEXP>=this.levelUpEXP;)this.levelEXP=this.levelEXP-this.levelUpEXP,this.levelUp()}levelUp(){this.level+=1,this.levelUpEXP=this.growthRate(this.level)}attack(t,e){return this.moves[t].use(this,e)}hurt(t,e){t&&(this.currHP-=t,this.currHP<0&&(this.currHP=0)),e&&null==this.status&&(this.status=e)}heal(t,e){t&&(this.currHP+=t),e&&this.status==e&&(this.status=null)}setLevel(t,e,s){this.level=t,this.load(this.specs),this.loadMoves(e,s)}load(t){this.setAbility(t.Abilities,t.HiddenAbility),this.setStats(...t.BaseStats),this.effortPoints=t.EffortPoints,this.baseExp=t.BaseEXP,this.eggMoves=t.EggMoves,this.evolutions=t.Evolutions,this.setGender(t.GenderRate),this.growthRate=this.setGrowth(t.GrowthRate),this.happiness=t.Happiness,this.name=t.Name,this.setMoves(t.Moves),this.stepsToHatch=t.StepsToHatch,this.setHoldItem(t),this.type1=t.Type1,this.type2=t.Type2,this.heal(this.HP),this.totalEXP=this.growthRate(this.level),this.levelUpEXP=this.growthRate(this.level+1)-this.growthRate(this.level)}setGrowth(t){return"Erratic"==t?function(t){return t<=50?t*t*t*(100-t)/50:t>50&&t<=68?t*t*t*(150-t)/100:t>68&&t<=98?t*t*t*Math.floor((1911-10*t)/3)/500:t>980&&t<=100?t*t*t*(160-t)/100:void 0}:"Fast"==t?function(t){return 4*t*t*t/5}:"Medium"==t?function(t){return t*t*t}:"Parabolic"==t?function(t){return 1.2*t*t*t-15*t*t+100*t-140}:"Slow"==t?function(t){return 5*t*t*t/4}:"Fluctuating"==t?function(t){let e=t*t*t;return t<=15?e*((Math.floor(t+1/3)+24)/50):t>15&&t<=36?e*((t+14)/50):t>36&&t<=100?e*((Math.floor(t/2)+32)/50):void 0}:void 0}setAbility(t,e){1==t[0].length?this.ability=t:this.ability=t[Math.floor(Math.random()*t.length)]}setHoldItem(t){let e,s,i=Math.random();if(t.WildItemCommon)s=t.WildItemCommon,e=.5;else if(t.WildItemUncommon)s=t.WildItemUncommon,e=.05;else{if(!t.WildItemRare)return void(this.holdItem="");s=t.WildItemRare,e=.01}this.holdItem=i<e?s:""}setGender(t){let e=Math.random(),s=0;"AlwaysMale"==t?this.gender="Male":"FemaleOneEighth"==t?s=1/8:"Female25Percent"==t?s=.25:"Female50Percent"==t?s=.5:"Female75Percent"==t?s=.75:"FemaleSevenEighths"==t?s=7/8:"AlwaysFemale"==t?this.gender="Female":"Genderless"==t&&(this.gender="Genderless"),s&&(this.gender=e<s?"Female":"Male")}setStats(t,e,s,i,o,a){this.HP=t+2*this.level,this.Attack=e+2*this.level,this.Defense=s+2*this.level,this.SpAttack=o+2*this.level,this.SpDefense=a+2*this.level,this.Speed=i+2*this.level}setMoves(t){let e=[];for(let s of t)s.level<=this.level&&e.push(s.move);for(let t=0;t<(4<e.length?4:e.length);t++){let t=e.splice(Math.floor(Math.random()*e.length),1)[0];this.attacks.push(t)}}loadMoves(t,e){for(let s of this.attacks)""==s?this.moves.push(new T):t&&t.has(s)&&this.moves.push(new T(t.get(s),e))}}function C(t,e){return function(s){let i=Math.floor(s/e)%t.length;return t[i]}}function S(t,e,s){return function(i){let o=Math.floor(i/s)%t.length;return{frameName:t[o],frameOffset:e[o]}}}class A{constructor(t,e,s){this.image=t,this.width=e,this.height=s,this.tiles=new Map,this.tilesTypes=new Map,this.animations=new Map,this.objects=new Map}load(t){if(t.tiles)for(let e of t.tiles)this.defineTile(e.name,e.type,e.index[0],e.index[1]);if(t.objects)for(let e of t.objects)this.defineTiles(e.name,e.type,e.size,e.indexes);if(t.frames)for(let e of t.frames)this.define(e.name,e.type,...e.rect);if(t.animations)for(let e of t.animations){let t;t=e.offsets?S(e.frames,e.offsets,e.frameLen):C(e.frames,e.frameLen),this.defineAnime(e.name,t)}}defineAnime(t,e){this.animations.set(t,e)}define(t,e="none",s,i,o,a){const n=[!1,!0].map(t=>{const e=document.createElement("canvas");e.width=o,e.height=a;const n=e.getContext("2d");return t&&(n.scale(-1,1),n.translate(-o,0)),n.drawImage(this.image,s,i,o,a,0,0,o,a),e});this.tiles.set(t,n),this.tilesTypes.set(t,e)}defineTile(t,e="none",s,i){this.define(t,e,s*this.width,i*this.height,this.width,this.height)}defineTiles(t,e="none",s,i){for(let o=0;o<s[0];o++)for(let a=0;a<s[1];a++)this.defineTile(`${t}-${s[0]*a+o}`,e,...i[s[0]*a+o]);this.objects.set(t,s)}draw(t,e,s,i,o=!1){const a=this.tiles.get(t)[o?1:0];e.drawImage(a,s,i)}drawInSize(t,e,s,i,o=1,a=!1){const n=this.tiles.get(t)[a?1:0];e.drawImage(n,s,i,n.width*o,n.height*o)}drawTile(t,e,s,i){this.draw(t,e,s*this.width,i*this.height)}drawBounds(t,e,s,i,o,a){if(t.bounds.size){let n=(s%t.bounds.size[0]+t.bounds.size[0])%t.bounds.size[0]+(i%t.bounds.size[1]+t.bounds.size[1])%t.bounds.size[1]*t.bounds.size[0],h=t.bounds.name+"-"+n;this.drawTile(h,e,s-o,i-a)}else this.drawTile(t.bounds.name,e,s-o,i-a)}drawAnime(t,e,s,i,o,a=!1){const n=this.animations.get(t),{frameName:h,frameOffset:r}=n(o);return this.draw(h,e,s,i,a),r}drawTileAnime(t,e,s,i,o){const a=this.animations.get(t);this.drawTile(a(o),e,s,i)}}function E(t){return new Promise(e=>{const s=new Image;s.addEventListener("load",()=>{e(s)}),s.src=t})}function R(t){return fetch(t).then(t=>t.json())}function B(t){return R(`/sprites/${t}.json`).then(t=>Promise.all([t,E(t.imageUrl)])).then(([t,e])=>{const s=new A(e,t.tileW,t.tileH);return s.load(t),s})}function F(t,e=3){var s="0000"+t;return s.substr(s.length-e)}function O(t,e,s,i){return Promise.all([R(`/Pokemons/${t}.json`),E(`/img/pokemon/Battlers/${F(t)}.png`),E(`/img/pokemon/Battlers/${F(t)}b.png`),E(`/img/pokemon/Battlers/icon${F(t)}.png`)]).then(([o,a,n,h])=>{const r=new I(t);return r.specs=o,r.front=a,r.back=n,r.icon=h,e&&s&&i&&r.setLevel(e,s,i),r})}class H{constructor(){this.items=new Map,this.pokemons=new Map,this.entities=new Map,this.areas=new Map,this.moves=new Map,this.typeTable=new Map}setPokemon(t,e){this.pokemons.has(t)||(e?this.pokemons.set(t,e):O(t).then(e=>{this.pokemons.set(t,e)}))}getPokemon(t){return this.pokemons.get(t)}add(t,e){"pokemon"==t&&this.setPokemon(e)}}function D(t){let e;return e=t||new H,Promise.all([R("/pokemon/moves.json"),R("/pokemon/types.json"),Promise.all([E("/img/battle-arenas/grass.png"),E("/img/battle-arenas/land.png")])]).then(([t,s,i,o])=>{for(let s of t)e.moves.set(s.InternalName,s);for(let t of s)e.typeTable.set(t.InternalName,t);let a=["grass","land"];for(let t=0;t<i.length;t++)e.areas.set(a[t],i[t]);return e})}function N(t,e){let s;return t&&(s=t),R("../../pokemon/"+e+"Graphics.json").then(t=>Promise.all(t.urls.map(E)).then(t=>(s.graphics=t,s)))}function G(t){let e;return e=t||new M,R("../../pokemon/battleGraphics.json").then(t=>Promise.all(t.urls.map(E)).then(t=>(e.graphics=t,e)))}function z(t,e,s,i,o){let a=0;for(let n of t)o.define(n,"noType",e+a*(o.width+i),s,o.width,o.height),a+=1}class L{constructor(){this.timer=new n(1/60),this.dataBase=new H,this.menu=new u,this.dialog=new p,this.battleStage=new M,this.partyPage=new b,this.bagPage=new P,this.trainerCardPage=new x,this.camera=new a,this.location=null,this.player=null}loadComponents(){return Promise.all([D(this.dataBase),N(this.partyPage,"party"),N(this.bagPage,"bag"),N(this.trainerCardPage,"trainerCard"),G(this.battleStage),E("/img/font.png").then(t=>{const e=new A(t,6,10);return z("ABCDEFGHIJKLMNOPQRSTUVWX",585,180,1,e),z("YZabcde",585,193,1,e),e.define("f","noType",634,193,5,10),z("gh",640,193,1,e),e.define("i","noType",654,193,2,10),e.define("j","noType",657,193,4,10),e.define("k","noType",662,193,6,10),e.define("l","noType",669,193,3,10),z("mnopqrstuvw",673,193,1,e),z("xyz",585,206,1,e),e.putText=function(t,s,i,o,a=1){let n=s;for(let s of t){let t=e.width;"i"==s?t=2:"l"==s?t=3:"j"==s?t=4:"f"==s&&(t=5),e.drawInSize(s,o,n,i,a),n+=(t+1)*a}},e})]).then(t=>{this.battleStage.PartyPage=this.partyPage,this.battleStage.BagPage=this.bagPage,this.battleStage.getPokemon=function(t){return game.dataBase.getPokemon(t)},this.battleStage.battleData={typeTable:this.dataBase.typeTable,moves:this.dataBase.moves},this.menu.font=t[5],this.battleStage.font=t[5]})}setPlayer(t){if(this.location){this.player=t;const e=this;this.menu.player=this.player,this.partyPage.party=this.player.party,this.menu.routAction=function(t,s){"Pokemons"==this.chosenItem&&("init"==t?e.partyPage.active=!0:"action"==t?e.partyPage.action(s,!0):"move"==t&&e.partyPage.move(s,!0),e.partyPage.active||(this.chosenItem=null))},this.player.warp=function(s){const i=e;if(i.location.neighbors&&i.location.neighbors.neighborsMap.has(s)){const e=i.location.neighbors.locationsMap.get(s),o=i.location.name;i.location.next(e,o);let a=i.location.tileCollider.tiles.searchByType("portal");for(let e of a)e.portal==o&&t.move(16*e.x,16*e.y)}},this.player.battle=function(t){game.battleStage.init(t),this.inBattle=!0,console.log(t)},this.player.getArea=function(t){return game.dataBase.areas.get(t)},this.location.entities.add(this.player)}}update(t){if(this.location){if(!this.location.change){const t=this;this.location.change=function(e,s){const i=Array.from(this.entities).pop();this.entities.delete(i),this.audio.pause(),this.audio.currentTime=0,this.active=!1,this.totalTime=0,t.location=e,s&&t.location.neighbors.locationsMap.set(s,this),t.location.entities.add(i)}}this.location.update(t)}this.menu.update(t),this.dialog.update(t),this.battleStage.update(t),this.partyPage.update(t)}draw(t){this.location&&(this.location.focus(this.camera,this.player),this.location.comp.draw(t,this.camera)),this.menu.draw(t),this.dialog.draw(t),this.battleStage.draw(t),this.partyPage.draw(t)}}class j{constructor(){this.layers=[]}draw(t,e){let s,i;this.layers.forEach(({name:o,draw:a})=>{"overlay"==o?s=a:"menu"==o?i=a:a(t,e)}),s&&s(t,e),i&&i(t)}}class q{constructor(t,e=16){this.matrix=t,this.tileSize=e}searchByType(t){let e=[];for(let s=0;s<this.matrix.grid.length;s++)for(let i=0;i<this.matrix.grid[0].length;i++)this.matrix.grid[s][i].type==t&&e.push({x:s,y:i,portal:this.matrix.grid[s][i].portal});return e}toIndex(t){return Math.floor(t/this.tileSize)}toIndexRange(t,e){const s=Math.ceil(e/this.tileSize)*this.tileSize,i=[];let o=t;do{i.push(this.toIndex(o)),o+=this.tileSize}while(o<s);return i}getByIndex(t,e){const s=this.matrix.get(t,e);if(s){const i=e*this.tileSize,o=i+this.tileSize,a=t*this.tileSize;return{tile:s,y1:i,y2:o,x1:a,x2:a+this.tileSize}}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}searchByRange(t,e,s,i){const o=[];return this.toIndexRange(t,e).forEach(t=>{this.toIndexRange(s,i).forEach(e=>{const s=this.getByIndex(t,e);s&&o.push(s)})}),o}}class X extends p{constructor(){super(),this.battleStage,this.stage=-1,this.fightingMenuCursor=new o(0,0),this.fightingMenu=["Fight","Pokemon","Bag","Run"],this.movesCursor=new o(0,0)}move(t,e){if(!e)return;let s;if(1==this.stage)s=this.fightingMenuCursor;else{if(2!=this.stage)return;s=this.movesCursor}"ArrowUp"==t?s.y=0:"ArrowDown"==t?s.y=1:"ArrowLeft"==t?s.x=0:"ArrowRight"==t&&(s.x=1)}action(t,e){e&&(t==l[0]?this.choose():t==l[1]&&this.back())}back(){0==this.stage||3==this.stage||(this.stage=1)}choose(){0==this.stage?this.nextMessage():1==this.stage?this.chooseFromFightingMenu():2==this.stage?this.chooseFromMoves():3==this.stage&&this.turnAction()}endOfMessageHandler(){this.clearMessages(),0==this.stage?this.stage=1:3==this.stage&&this.turnAction()}chooseFromFightingMenu(){const t=this.fightingMenuCursor.x+2*this.fightingMenuCursor.y,e=this.fightingMenu[t];this.turnIndex=0,"Fight"==e?this.stage=2:"Pokemon"==e?this.battleStage.activateParty():"Bag"==e?this.battleStage.activateBag():"Run"==e&&this.battleStage.end()}chooseFromMoves(){this.movesCursor.x,this.movesCursor.y;this.stage=3,this.clearMessages(),this.turnAction()}turnAction(){this.messages.length>1?this.nextMessage():0!=this.battleStage.battle.foe.pokemon.currHP?this.battle.turnIndex<this.battle.turnNum?this.startTurn():this.battle.turnIndex==this.battle.turnNum&&(this.stage=1,this.battle.turnIndex=0):this.battleStage.end()}startTurn(){const t=this.movesCursor.x+2*this.movesCursor.y;this.battleStage.battle.player.party.pokemons[this.battleStage.battle.player.party.fightingPokemon];let e=[];e=this.battleStage.battle.startTurn({type:"move",moveIndex:t}),this.clearMessages(),this.addMessages(e)}drawComponent(t){if(0==this.stage||3==this.stage)f(0,112,240,48,this.messages[this.messagePhase])(t);else if(1==this.stage){f(0,112,240,48,`What will\n${this.fightingPokemon.name} do?`)(t);let e=this.fightingMenuCursor.x+2*this.fightingMenuCursor.y;U(this.fightingMenu,e,80,48,t)}else if(2==this.stage){let e=this.movesCursor.x+2*this.movesCursor.y;U(this.fightingPokemon.moves,e,240,48,t)}}loadBattle(t){-1==this.stage&&(this.stage=0,this.battle=t,this.fightingPokemon=t.player.party.pokemons[t.player.party.fightingPokemon],this.initMessages(),this.addMessages([`A wild ${t.foe.pokemon.name} appeared!`,`I choose you! ${this.fightingPokemon.name}!`]))}update(t){this.battle&&(this.fightingPokemon=this.battle.player.party.pokemons[this.battle.player.party.fightingPokemon])}}function U(t,e,s,i,o){f(240-s,160-i,s,i)(o);const a={font:"7px Arial",fill:"#FFF",border:"#F00"};let n,h=[];if(t[0].Name)for(let e of t)h.push(e.Name);else for(let e of t)h.push(e);n=0==e?a:void 0,f(240-s,160-i,s/2,i/2,h[0],n)(o),n=1==e?a:void 0,f(240-s+s/2,160-i,s/2,i/2,h[1],n)(o),n=2==e?a:void 0,f(240-s,160-i+i/2,s/2,i/2,h[2],n)(o),n=3==e?a:void 0,f(240-s+s/2,160-i+i/2,s/2,i/2,h[3],n)(o)}class W extends class{constructor(t,e){this.arena=t,this.player=e,this.dialog=null,this.foe=null,this.ally=null,this.type,this.turnNum=0,this.turnIndex=0}init(){this.dialog=new X,"single"==this.type?this.turnNum=2:this.turnNum=4}startTurn(t){let e=[];return 0==this.turnIndex&&"move"==t.type&&(this.playerMove={type:"move",moveIndex:t.moveIndex},this.foeMove={type:"move",moveIndex:Math.floor(Math.random()*this.foe.pokemon.attacks.length)}),this.turnIndex<this.turnNum&&(e=this.moveTurn()),e}moveTurn(){let t=this.player.party.pokemons[this.player.party.fightingPokemon],e=[];return 0==this.turnIndex&&(e=t.attack(this.playerMove.moveIndex,this.foe.pokemon)),0==this.foe.pokemon.currHP?(this.rewardExp(),this.turnIndex=this.turnNum,e):(1==this.turnIndex&&(e=this.foe.pokemon.attack(this.foeMove.moveIndex,t)),this.turnIndex+=1,e)}rewardExp(){let t,e,s,i,o,a,n,h,r,l=0,c=this.player.party.pokemons[this.player.party.fightingPokemon];t="wildSingle"==this.foe.type?1:1.5,s=this.foe.pokemon.baseExp,i="Lucky Egg"==c.holdItem?1.5:1,n=1,o=this.foe.pokemon.level,a=1,r=1,e=1,h=1,l=1*t*s*i*o*1*1*1/7,c.gainEXP(l)}update(t){this.dialog.update(t)}move(t,e){this.dialog.move(t,e)}action(t,e){this.dialog.action(t,e)}getAlly(){return this.ally?this.ally:(console.log("no ally"),!1)}getFoe(){return this.foe?this.foe:(console.log("no foe"),!1)}end(){this.player.inBattle=!1}}{constructor(t,e,s,i){super(t,e),this.type="single",this.foe={type:"wildSingle",id:s,level:i}}init(t){super.init(),this.dialog.font=t.font,this.dialog.battleStage=t;let e=t.getPokemon(this.foe.id);this.foe.pokemon=Object.assign(new I,e),this.foe.pokemon.setLevel(this.foe.level,t.battleData.moves,t.battleData.typeTable)}end(){this.player.inBattle=!1}}class ${constructor(t,e,s){this.pos=t,this.size=e,this.offset=s}overlaps(t){return this.bottom>t.top&&this.top<t.bottom&&this.left<t.right&&this.right>t.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}}const Y={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),LEFT:Symbol("left"),RIGHT:Symbol("right")};class _{constructor(t){this.NAME=t}obstruct(){}move(){}collides(){}hold(){}resume(){}interact(t,e,s,i){}update(){}}class K{constructor(){this.pos=new o(0,0),this.vel=new o(0,0),this.size=new o(0,0),this.offset=new o(0,0),this.bounds=new $(this.pos,this.size,this.offset),this.lifetime=0,this.heading=Y.DOWN,this.traits=[],this.role}addTrait(t){this.traits.push(t),this[t.NAME]=t}obstruct(t,e){this.traits.forEach(s=>{s.obstruct(this,t,e)})}move(t,e){this.traits.forEach(s=>{s.move(this,t,e)})}collides(t){this.traits.forEach(e=>{e.collides(this,t)})}hold(){this.traits.forEach(t=>{t.hold()})}resume(){this.traits.forEach(t=>{t.resume()})}interact(t,e,s){this.traits.forEach(i=>{i.interact(this,t,e,s)})}update(t){this.traits.forEach(e=>{e.update(this,t)}),this.lifetime+=t}}class Z{constructor(t){this.tiles=new q(t),this.battleAreas=new Map}addToArea(t,e){if(this.battleAreas.has(t)){this.battleAreas.get(t).set(e.name,e)}else this.battleAreas.set(t,new Map),this.addToArea(t,e)}checkY(t){let e;if(t.vel.y>0)e=t.bounds.bottom;else{if(!(t.vel.y<0))return;e=t.bounds.top}this.tiles.searchByRange(t.bounds.left,t.bounds.right,e,e).forEach(e=>{("solid"===e.tile.type||"portal"===e.tile.type||this.battleAreas.has(e.tile.type))&&("portal"!=e.tile.type||"Player"!=t.role?"Player"!=t.role||t.inBattle||!this.battleAreas.has(e.tile.type)?t.vel.y>0?t.bounds.bottom>e.y1&&t.obstruct(Y.BOTTOM,e):t.vel.y<0&&t.bounds.top<e.y2&&t.obstruct(Y.TOP,e):this.encounter(t,e.tile.type):t.warp(e.tile.portal))})}checkX(t){let e;if(t.vel.x>0)e=t.bounds.right;else{if(!(t.vel.x<0))return;e=t.bounds.left}this.tiles.searchByRange(e,e,t.bounds.top,t.bounds.bottom).forEach(e=>{("solid"===e.tile.type||"portal"===e.tile.type||this.battleAreas.has(e.tile.type))&&("portal"!=e.tile.type||"Player"!=t.role?"Player"!=t.role||t.inBattle||!this.battleAreas.has(e.tile.type)?t.vel.x>0?t.bounds.right>e.x1&&t.obstruct(Y.RIGHT,e):t.vel.x<0&&t.pos.x<e.x2&&t.obstruct(Y.LEFT,e):this.encounter(t,e.tile.type):t.warp(e.tile.portal))})}test(t){0!=t.vel.y&&this.checkY(t),0!=t.vel.x&&this.checkX(t)}encounter(t,e){if(16*Math.random()<.2){const s=this.battleAreas.get(e);let i=Math.random();for(let[o,a]of s){if(i<a.rate){let s=Math.round(Math.random()*(a.levels[1]-a.levels[0]))+a.levels[0],i=t.getArea(e);return void t.battle(new W(i,t,a.id,s))}i-=a.rate}}}}class J{constructor(){this.neighborsMap=new Map,this.locationsMap=new Map,this.north=0,this.south=19,this.west=0,this.east=20}setBoundries(t){this.east=t.grid.length-1,this.south=t.grid[0].length-1}addNeighbor(t,e){t&&this.neighborsMap.set(t,e)}getNeighbor(t,e){let s=!1;t>=this.west&&t<=this.east&&(s=!0);let i=!1;if(e>=this.north&&e<=this.south&&(i=!0),e<this.north){if(s&&this.neighborsMap.get("north"))return{neighbor:this.locationsMap.get("north"),xNeighbor:t,yNeighbor:e,direction:"north",fromDirection:"south"}}else if(e>this.south){if(s&&this.neighborsMap.get("south"))return{neighbor:this.locationsMap.get("south"),xNeighbor:t,yNeighbor:e-this.south-1,direction:"south",fromDirection:"north"}}else if(t<this.west){if(i&&this.neighborsMap.get("west"))return{neighbor:this.locationsMap.get("west"),xNeighbor:t,yNeighbor:e,direction:"west",fromDirection:"east"}}else if(t>this.east&&i&&this.neighborsMap.get("east"))return{neighbor:this.locationsMap.get("east"),xNeighbor:t-this.east-1,yNeighbor:e,direction:"east",fromDirection:"west"};return{neighbor:!1,xNeighbor:t,yNeighbor:e,direction:void 0,fromDirection:void 0}}getNeighborTile(t,e){const{neighbor:s,xNeighbor:i,yNeighbor:o}=this.getNeighbor(t,e);if(s){const t=s.tileCollider.tiles.matrix.grid.length,e=s.tileCollider.tiles.matrix.grid[0].length,a=(i%t+t)%t,n=(o%e+e)%e,h=s.comp.layers;let r;for(let t of h)if("drawBackgroundLayer"==t.draw.name){let e=t.draw(null,null,[a,n]);e&&(r=e)}return r}}loadLocation(){}create(){this.neighborsMap.forEach((t,e)=>{void 0===this.locationsMap.get(e)&&this.loadLocation(t).then(t=>{this.locationsMap.set(e,t)})})}}class Q{constructor(t){this.entities=t}check(t){this.entities.forEach(e=>{t!==e&&t.bounds.overlaps(e.bounds)&&(t.collides(e),e.collides(t))})}}class V{constructor(t){this.name=t,this.comp=new j,this.entities=new Set,this.entityCollider=new Q(this.entities),this.tileCollider=null,this.totalTime=0,this.bounds={name:"big-tree",size:[2,2]},this.audio=new Audio,this.neighbors=new J,this.active=!1}addToDataBase(){}next(t,e){this.change(t,e)}moveLocation(t){const[e,s]=t.pos.toIndex(),i=this.tileCollider.tiles.matrix.grid[e];if(null==i||null==i[s]){const{neighbor:i,xNeighbor:o,yNeighbor:a,fromDirection:n}=this.neighbors.getNeighbor(e,s),h=i.tileCollider.tiles.matrix.grid.length+1,r=i.tileCollider.tiles.matrix.grid[0].length+1,l=(o%h+h)%h,c=(a%r+r)%r;this.next(i,n),t.move(16*l,16*c)}}focus(t,e){this.moveLocation(e),t.pos.set(e.pos.x-120+e.size.x/2,e.pos.y-80+e.size.y/2)}init(){this.audio.play(),this.neighbors.setBoundries(this.tileCollider.tiles.matrix),this.neighbors.create(),this.active=!0}update(t){!this.active&&this.totalTime>0&&this.init(),this.entities.forEach(e=>{e.update(t),this.tileCollider.test(e),this.entityCollider.check(e)}),this.totalTime+=t}setupEncounter(t){if(t.encounters)for(let e in t.encounters)for(let s of t.encounters[e])this.tileCollider.addToArea(e,s),this.addToDataBase("pokemon",s.id)}setup(t,e,s,i){this.neighbors.loadLocation=s,this.setupCollision(t,i),this.setupBackgrounds(t,i),this.setupEntities(t,e),this.setupAudio(t),this.setupNeigbors(t),this.setupEncounter(t)}setupEntities(t,e){if(t.entities){t.entities.forEach(({name:t,pos:[s,i],messages:o})=>{const a=(0,e[t])();a.pos.set(s,i),a.messages=o,this.entities.add(a)});const s=function(t,e=64,s=64){const i=document.createElement("canvas");i.width=e,i.height=s;const o=i.getContext("2d");return function(a,n){t.forEach(t=>{o.clearRect(0,0,e,s),t.draw(o);let h=t.pos.x-n.pos.x,r=t.pos.y-n.pos.y;t.offset&&(h+=t.offset.x,r+=t.offset.y),a.drawImage(i,h,r)})}}(this.entities);this.comp.layers.push({name:"entities",draw:s})}}setupAudio(t){t.audio&&(this.audio.src=t.audio,this.audio.loop=!0)}setupNeigbors(t){t.neighbors&&t.neighbors.forEach(({direction:t,location:e})=>{this.neighbors.addNeighbor(t,e)})}setupCollision(t,e){const s=function(t,e,s){const o=new i;for(const{tileObj:i,x:a,y:n}of at(t,e,s))i.portal?o.set(a,n,{type:i.type,portal:i.portal}):o.set(a,n,{type:i.type});return o}(t.layers.reduce((t,e)=>t.concat(e.tiles),[]),t,e);this.tileCollider=new Z(s)}setupBackgrounds(t,e){t.layers.forEach(s=>{for(const t of s.tiles)for(const s in t)"bounds"==s&&(this.bounds={name:t.name},e.objects.has(t.name)&&(this.bounds.size=e.objects.get(t.name)));const o=function(t,e,s,i){const o=new q(e),a=document.createElement("canvas");a.width=272,a.height=192;const n=a.getContext("2d");let h,r,l,c;function d(o,d,u,g){n.clearRect(0,0,a.width,a.height),h=o,r=d,l=u,c=g;for(let o=h;o<=r;o++)for(let a=l;a<=c;a++){let r=e.grid[o];if(r){let e=r[a];if(e)s.animations.has(e.name)?s.drawTileAnime(e.name,n,o-h,a-l,t.totalTime):s.drawTile(e.name,n,o-h,a-l);else if("background"==i){let e=t.neighbors.getNeighborTile(o,a);e?s.drawTile(e,n,o-h,a-l):s.drawBounds(t,n,o,a,h,l)}}else if("background"==i){let e=t.neighbors.getNeighborTile(o,a);e?s.drawTile(e,n,o-h,a-l):s.drawBounds(t,n,o,a,h,l)}}}return function(t,s,i){if(i){let t=e.grid[i[0]];if(t){let e=t[i[1]];if(e)return e.name}return}const n=o.toIndex(s.size.x),h=o.toIndex(s.pos.x),r=h+n,l=o.toIndex(s.size.y),c=o.toIndex(s.pos.y);d(h,r,c,c+l);let u=-(s.pos.x%16+16)%16,g=-(s.pos.y%16+16)%16;t.drawImage(a,u,g)}}(this,function(t,e,s){const o=new i;for(const{tileObj:i,x:a,y:n}of at(t,e,s))o.set(a,n,{name:i.name});return o}(s.tiles,t,e),e,s.name);this.comp.layers.push({name:s.name,draw:o})})}}function*tt(t,e,s,i){for(let o=t;o<=e;++o)for(let t=s;t<=i;++t)yield{x:o,y:t}}function*et(t,e,s,i,o){let a=0,n=0;for(let h=t;h<=e;++h,a=(a+1)%o[0])for(let t=s;t<=i;++t,n=(n+1)%o[1]){let e=o[0]*n+a;yield{x:h,y:t,objectPart:e}}}function st(t){if(4===t.length){const[e,s,i,o]=t;return tt(e,s,i,o)}if(3===t.length){const[e,s,i]=t;return tt(e,s,i,i)}if(2===t.length){const[e,s]=t;return tt(e,e,s,s)}}function it(t,e){if(4===t.length){const[s,i,o,a]=t;return et(s,i,o,a,e)}if(3===t.length){const[s,i,o]=t;return et(s,i,o,o,e)}if(2===t.length){const[s,i]=t,[o,a]=e;return et(s,s+o-1,i,i+a-1,e)}}function*ot(t){for(const e of t)yield*st(e)}function*at(t,e,s){function*i(t,e,i,o){for(const{x:i,y:o,objectPart:a}of function*(t,e){for(const s of t)yield*it(s,e)}(t.ranges,e)){const e=`${t.name}-${a}`,n={name:e,type:s.tilesTypes.get(e)};t.portals&&(n.portal=t.portals[0]),yield{tileObj:n,x:i,y:o}}}yield*function*(t,e,o){for(const e of t){let t=0;for(const{x:o,y:a}of ot(e.ranges))if(s.objects.has(e.name)){const t=s.objects.get(e.name);yield*i(e,t)}else{const i={name:e.name,type:s.tilesTypes.get(e.name)};e.portals&&(i.portal=e.portals[t++]),yield{tileObj:i,x:o,y:a}}}}(t)}class nt{constructor(){this.pokemons=[],this.fightingPokemon=0}getFightingPokemon(){return this.pokemons[this.fightingPokemon]}addPokemon(t){this.pokemons.length<6?this.pokemons.push(t):console.warn("party is full")}switch(t,e){if(t<this.pokemons.length&&e<this.pokemons.length){let s=this.pokemons[t];this.pokemons[t]=this.pokemons[e],this.pokemons[e]=s}}}class ht extends K{constructor(){super(),this.role="Trainer",this.party=new nt}}const rt=["ArrowRight","ArrowLeft","ArrowUp","ArrowDown"];class lt extends _{constructor(){super("walk"),this.overrideHold=!1,this.stepWidth=16,this.walkingSpeed=170,this.toGo=0,this.vel=new o(0,0),this.startPos=new o(-1,-1),this.walkedDistance=0,this.halt=!1,this.direction=!1,this.queue=[]}hold(){this.overrideHold=!0}resume(){this.overrideHold=!1}move(t,e,s){this.toGo=0,this.walkedDistance=0,this.startPos.set(e,s),t.pos.set(e,s)}start(){this.direction=this.queue[0],this.halt=!1,"ArrowRight"==this.direction?this.vel.set(this.walkingSpeed,0):"ArrowLeft"==this.direction?this.vel.set(-this.walkingSpeed,0):"ArrowDown"==this.direction?this.vel.set(0,this.walkingSpeed):"ArrowUp"==this.direction?this.vel.set(0,-this.walkingSpeed):this.vel.set(0,0)}enqueue(t){this.queue.indexOf(t)>=0||this.queue.unshift(t)}cancel(t){if(t){let e=this.queue.indexOf(t);e>=0&&this.queue.splice(e,1)}else rt.map(this.cancel,this);this.halt=!0}collides(t,e){this.vel.x>0?t.bounds.right=e.bounds.left:this.vel.x<0?t.bounds.left=e.bounds.right:this.vel.y<0?t.bounds.top=e.bounds.bottom:this.vel.y>0&&(t.bounds.bottom=e.bounds.top),this.reset()}reset(){this.vel.set(0,0),this.walkedDistance=0,this.toGo=0,this.halt=!1,this.startPos.set(-1,-1)}obstruct(t,e,s){e===Y.TOP?t.pos.y=s.y2:e===Y.BOTTOM?t.pos.y=s.y1-t.size.y:e===Y.RIGHT?t.pos.x=s.x1-t.size.x:e===Y.LEFT&&(t.pos.x=s.x2),this.toGo=0,this.reset()}update(t,e){this.overrideHold||(this.startPos.x<0&&this.startPos.y<0&&this.startPos.set(t.pos.x,t.pos.y),(this.queue.length>0&&this.direction!=this.queue[0]||1==this.queue.length&&0==this.toGo)&&(!this.halt&&this.toGo>0&&(this.halt=!0),0==this.toGo&&this.start()),this.walkedDistance+=this.vel.distance(e),!this.halt&&this.walkedDistance>this.toGo&&(this.toGo+=this.stepWidth),this.halt?this.toGo-this.walkedDistance>0?(t.pos.x+=this.vel.distanceX(e),t.pos.y+=this.vel.distanceY(e)):("ArrowRight"==this.direction||"ArrowLeft"==this.direction?t.pos.x=this.startPos.x+this.toGo*Math.sign(this.vel.x):"ArrowUp"!=this.direction&&"ArrowDown"!=this.direction||(t.pos.y=this.startPos.y+this.toGo*Math.sign(this.vel.y)),this.reset()):(t.pos.x+=this.vel.distanceX(e),t.pos.y+=this.vel.distanceY(e)),t.vel=this.vel,t.vel.x>0?t.heading=Y.RIGHT:t.vel.x<0?t.heading=Y.LEFT:t.vel.y<0?t.heading=Y.TOP:t.vel.y>0&&(t.heading=Y.BOTTOM))}}class ct extends _{constructor(){super("talk"),this.poi=void 0,this.collidePos=new o(0,0),this.collideHeading=void 0,this.collidePosPOI=new o(0,0),this.talking=!1,this.phase=0}ready(t){if(this.poi){if(t.heading==this.collideHeading&&t.pos.toIndex()[0]==this.collidePos.toIndex()[0]&&t.pos.toIndex()[1]==this.collidePos.toIndex()[1]&&this.poi.pos.toIndex()[0]==this.collidePosPOI.toIndex()[0]&&this.poi.pos.toIndex()[1]==this.collidePosPOI.toIndex()[1])return!0;this.poi=void 0}return!1}interact(t,e,s,i){e!=l[0]&&e!=l[1]||!s||this.commandState==s||(!this.talking&&this.ready(t)&&this.start(t,i),this.talking&&this.next(t)),this.commandState=s}start(t,e){this.dialog=e.dialog,this.dialog.initMessages(-1),this.dialog.addMessages(this.poi.messages),this.talking=!0,this.poi.heading=function(t){if(t==Y.TOP)return Y.BOTTOM;if(t==Y.RIGHT)return Y.LEFT;if(t==Y.LEFT)return Y.RIGHT;if(t==Y.BOTTOM)return Y.TOP}(this.collideHeading),t.hold(),this.poi.hold()}next(t){this.dialog.nextMessage(),this.dialog.active||this.finish(t)}collides(t,e){this.poi||(this.collidePos.set(t.pos.x,t.pos.y),this.collideHeading=t.heading,this.collidePosPOI.set(e.pos.x,e.pos.y),this.poi=e)}finish(t){this.talking=!1,this.poi.resume(),t.resume(),this.phase=0}update(t,e){this.ready(t)}}function dt(t){function e(e){const s=(i=this).vel.y>0?"walk-down":i.vel.y<0?"walk-up":0!=i.vel.x&&"walk-left";var i;if(s){let i=t.drawAnime(s,e,0,0,this.walk.walkedDistance,this.vel.x>0);this.offset.set(...i)}else this.heading===Y.RIGHT?t.draw("looking-left",e,0,0,!0):this.heading===Y.LEFT?t.draw("looking-left",e,0,0):this.heading===Y.TOP?t.draw("looking-up",e,0,0):this.heading===Y.BOTTOM&&t.draw("looking-down",e,0,0)}return function(){const t=new ht;return t.size.set(16,16),t.heading=Y.BOTTOM,t.addTrait(new lt),t.addTrait(new ct),t.offset=new o(1,-5),t.draw=e,t.role="Player",t}}const ut=["ArrowRight","ArrowLeft","ArrowUp","ArrowDown"];class gt extends _{constructor(){super("randomWalk"),this.overrideHold=!1,this.stepWidth=16,this.walkingSpeed=50,this.toGo=0,this.vel=new o(0,0),this.startPos=new o(-1,-1),this.walkedDistance=0,this.halt=!1,this.direction=!1,this.movePrecent=1,this.distanceFromStart=new o(0,0),this.maxDistanceFromStart=new o(40,40),this.queue=[]}hold(){this.overrideHold=!0}resume(){this.overrideHold=!1}start(){this.direction=this.queue[0],this.halt=!1,"ArrowRight"==this.direction?this.vel.set(this.walkingSpeed,0):"ArrowLeft"==this.direction?this.vel.set(-this.walkingSpeed,0):"ArrowDown"==this.direction?this.vel.set(0,this.walkingSpeed):"ArrowUp"==this.direction?this.vel.set(0,-this.walkingSpeed):this.vel.set(0,0)}enqueue(t){this.queue.indexOf(t)>=0||this.queue.unshift(t)}cancel(t){let e=this.queue.indexOf(t);e>=0&&this.queue.splice(e,1),this.halt=!0}reset(){this.distanceFromStart.x+=this.toGo*Math.sign(this.vel.x),this.distanceFromStart.y+=this.toGo*Math.sign(this.vel.y),this.vel.set(0,0),this.walkedDistance=0,this.toGo=0,this.halt=!1,this.startPos.set(-1,-1)}random(){let t=Math.floor(100*Math.random());if(t<this.movePrecent){t=Math.floor(100*Math.random());let e=["ArrowRight","ArrowLeft","ArrowUp","ArrowDown"];this.distanceFromStart.x>this.maxDistanceFromStart.x?pt(e,ut[0]):this.distanceFromStart.x<-this.maxDistanceFromStart.x?pt(e,ut[1]):this.distanceFromStart.y>this.maxDistanceFromStart.y?pt(e,ut[3]):this.distanceFromStart.y<-this.maxDistanceFromStart.y&&pt(e,ut[2]),this.enqueue(e[t%4])}}obstruct(t,e,s){e===Y.TOP?t.pos.y=s.y2:e===Y.BOTTOM?t.pos.y=s.y1-t.size.y:e===Y.RIGHT?t.pos.x=s.x1-t.size.x:e===Y.LEFT&&(t.pos.x=s.x2),this.toGo=0,this.reset()}collides(t,e){this.toGo>0&&(t.pos.x=this.startPos.x,t.pos.y=this.startPos.y,this.toGo=0,this.reset())}update(t,e){this.overrideHold||(this.startPos.x<0&&this.startPos.y<0&&this.startPos.set(t.pos.x,t.pos.y),0==this.queue.length?this.random():this.cancel(this.queue[0]),(this.queue.length>0&&this.direction!=this.queue[0]||1==this.queue.length&&0==this.toGo)&&(!this.halt&&this.toGo>0&&(this.halt=!0),0==this.toGo&&this.start()),this.walkedDistance+=this.vel.distance(e),!this.halt&&this.walkedDistance>this.toGo&&(this.toGo+=this.stepWidth),this.halt?this.toGo-this.walkedDistance>0?(t.pos.x+=this.vel.distanceX(e),t.pos.y+=this.vel.distanceY(e)):("ArrowRight"==this.direction||"ArrowLeft"==this.direction?t.pos.x=this.startPos.x+this.toGo*Math.sign(this.vel.x):"ArrowUp"!=this.direction&&"ArrowDown"!=this.direction||(t.pos.y=this.startPos.y+this.toGo*Math.sign(this.vel.y)),this.reset()):(t.pos.x+=this.vel.distanceX(e),t.pos.y+=this.vel.distanceY(e)),t.vel=this.vel,t.vel.x>0?t.heading=Y.RIGHT:t.vel.x<0?t.heading=Y.LEFT:t.vel.y<0?t.heading=Y.TOP:t.vel.y>0&&(t.heading=Y.BOTTOM))}}function pt(t,e){let s=t.indexOf(e);return s>=0&&t.splice(s,1),t}function mt(t){return B(t).then(e=>function(t,e){return function(){return new ft(t,e)}}(t,e))}class ft extends K{constructor(t,e){super(),this.name=t,this.size.set(16,16),this.addTrait(new gt),this.offset=new o(1,-5),this.sprite=e,this.heading=Y.BOTTOM,this.role="NPC"}draw(t){const e=function(t){if(t.vel.y>0)return"walk-down";if(t.vel.y<0)return"walk-up";if(0!=t.vel.x)return"walk-left";return!1}(this);if(e){let s=this.sprite.drawAnime(e,t,0,0,this.randomWalk.walkedDistance,this.vel.x>0);this.offset.set(...s)}else this.heading===Y.RIGHT?this.sprite.draw("looking-left",t,0,0,!0):this.heading===Y.LEFT?this.sprite.draw("looking-left",t,0,0):this.heading===Y.TOP?this.sprite.draw("looking-up",t,0,0):this.heading===Y.BOTTOM&&this.sprite.draw("looking-down",t,0,0)}}!async function(t){var e=t.getContext("2d");const s=new L,i=await function(){const t={},e=[];function s(e){return s=>t[e]=s}return["mom","fatBoy","pinkBoy","hatBoy"].forEach(t=>{e.push(mt(t).then(s(t)))}),Promise.all([B("brendan").then(dt).then(s("brendan")),...e]).then(()=>t)}(),o=await function(t,e){return function s(i){return R(`/locations/${i}.json`).then(t=>Promise.all([t,B(t.spriteSheet)])).then(([o,a])=>{const n=new V(i);return n.addToDataBase=function(t,s){e.add.call(e,t,s)},n.setup(o,t,s,a),n})}}(i,s.dataBase),a=await o("101");s.loadComponents().then(()=>{O(150,70,s.dataBase.moves,s.dataBase.typeTable).then(t=>{s.dataBase.setPokemon(t.id,t),n.party.addPokemon(t)}),O(134,60,s.dataBase.moves,s.dataBase.typeTable).then(t=>{s.dataBase.setPokemon(t.id,t),n.party.addPokemon(t)}),O(500,70,s.dataBase.moves,s.dataBase.typeTable).then(t=>{s.dataBase.setPokemon(t.id,t),n.party.addPokemon(t)}),O(400,70,s.dataBase.moves,s.dataBase.typeTable).then(t=>{s.dataBase.setPokemon(t.id,t),n.party.addPokemon(t)})}),s.location=a;const n=i.brendan();s.setPlayer(n),n.pos.set(96,176),window.game=s,function(t){const e=new h;e.addMapping("Enter",e=>{t.battleStage.active||t.dialog.active||(t.menu.active=e?!t.menu.active:t.menu.active,t.player.walk.cancel())}),r.forEach(s=>{e.addMapping(s,e=>{t.menu.active||t.player.inBattle?t.menu.active?(t.menu.move(s,e),t.player.walk.cancel()):t.player.inBattle&&(t.battleStage.move(s,e),t.player.walk.cancel()):e?t.player.walk.enqueue(s):t.player.walk.cancel(s)})}),l.forEach(s=>{e.addMapping(s,e=>{t.menu.active||t.battleStage.active?t.battleStage.active?t.battleStage.action(s,e):t.menu.active&&t.menu.action(s,e):t.player.interact(s,e,t)})}),e.addMapping("ShiftRight",e=>{t.battleStage.active&&(t.battleStage.end(),t.player.inBattle=!1)}),e.listenTo(window)}(s),function(t,e){t.addEventListener("click",(function(t){console.log("indexLogger:"),console.log(Math.floor((t.offsetX+e.pos.x)/16),Math.floor((t.offsetY+e.pos.y)/16))}))}(t,s.camera),s.timer.update=function(t){s.update(t),s.draw(e)},s.timer.start()}(document.getElementById("screen"))}]);